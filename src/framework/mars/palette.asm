; ------------------------------------------------------------------------------
; GameTap 32X
; By Ollie_Ollie_TechDeck
; ------------------------------------------------------------------------------
; Palette functions
; ------------------------------------------------------------------------------

	section sh2_code
	include	"src/framework/mars.inc"

; ------------------------------------------------------------------------------
; Update CRAM buffer
; ------------------------------------------------------------------------------

UpdateMarsCram:
	mov.l	#palette,r1					; Palette buffer
	mov.l	#cram_buffer,r2					; CRAM buffer
	mov.w	#$100,r3					; Number of colors

	mov.l	#pal_fade_intensity,r0				; Get brightness tables
	mov.l	@r0,r0
	mov.l	#.BrightnessBlue,r4
	add	r0,r4
	mov.l	#.BrightnessGreen,r5
	add	r0,r5
	mov.l	#.BrightnessRed,r6
	add	r0,r6

	mov.b	#$3E,r7						; Red mask/max value
	mov.w	#$8000,r8					; Priority mask

.Loop:
	mov.w	@r1,r0						; Get blue value
	shlr8	r0
	shlr	r0
	and	r7,r0
	mov.w	@(r0,r4),r9
	
	mov.w	@r1,r0						; Get green value
	shlr2	r0
	shlr2	r0
	and	r7,r0
	mov.w	@(r0,r5),r10
	
	mov.w	@r1,r0						; Get red value
	add	r0,r0
	and	r7,r0
	mov.w	@(r0,r6),r11
	
	mov.w	@r1+,r0						; Store color
	and	r8,r0
	or.l	r9,r0
	or	r10,r0
	or	r11,r0
	mov.w	r0,@r2
	
	dt	r3						; Decrement number of colors left
	bf/s	.Loop						; If there's still colors to fade, loop
	add	#2,r2

	rts
	nop

; ------------------------------------------------------------------------------

	lits
	
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000
.BrightnessBlue:
	dc.w	$0000, $0400, $0800, $0C00, $1000, $1400, $1800, $1C00
	dc.w	$2000, $2400, $2800, $2C00, $3000, $3400, $3800, $3C00
	dc.w	$4000, $4400, $4800, $4C00, $5000, $5400, $5800, $5C00
	dc.w	$6000, $6400, $6800, $6C00, $7000, $7400, $7800, $7C00
	dc.w	$7C00, $7C00, $7C00, $7C00, $7C00, $7C00, $7C00, $7C00
	dc.w	$7C00, $7C00, $7C00, $7C00, $7C00, $7C00, $7C00, $7C00
	dc.w	$7C00, $7C00, $7C00, $7C00, $7C00, $7C00, $7C00, $7C00
	dc.w	$7C00, $7C00, $7C00, $7C00, $7C00, $7C00, $7C00
	
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000
.BrightnessGreen:
	dc.w	$0000, $0020, $0040, $0060, $0080, $00A0, $00C0, $00E0
	dc.w	$0100, $0120, $0140, $0160, $0180, $01A0, $01C0, $01E0
	dc.w	$0200, $0220, $0240, $0260, $0280, $02A0, $02C0, $02E0
	dc.w	$0300, $0320, $0340, $0360, $0380, $03A0, $03C0, $03E0
	dc.w	$03E0, $03E0, $03E0, $03E0, $03E0, $03E0, $03E0, $03E0
	dc.w	$03E0, $03E0, $03E0, $03E0, $03E0, $03E0, $03E0, $03E0
	dc.w	$03E0, $03E0, $03E0, $03E0, $03E0, $03E0, $03E0, $03E0
	dc.w	$03E0, $03E0, $03E0, $03E0, $03E0, $03E0, $03E0
	
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000, $0000
	dc.w	$0000, $0000, $0000, $0000, $0000, $0000, $0000
.BrightnessRed:
	dc.w	$0000, $0001, $0002, $0003, $0004, $0005, $0006, $0007
	dc.w	$0008, $0009, $000A, $000B, $000C, $000D, $000E, $000F
	dc.w	$0010, $0011, $0012, $0013, $0014, $0015, $0016, $0017
	dc.w	$0018, $0019, $001A, $001B, $001C, $001D, $001E, $001F
	dc.w	$001F, $001F, $001F, $001F, $001F, $001F, $001F, $001F
	dc.w	$001F, $001F, $001F, $001F, $001F, $001F, $001F, $001F
	dc.w	$001F, $001F, $001F, $001F, $001F, $001F, $001F, $001F
	dc.w	$001F, $001F, $001F, $001F, $001F, $001F, $001F

; ------------------------------------------------------------------------------
